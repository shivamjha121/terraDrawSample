<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Image Layers + Terra Draw with Maplibre</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css"
    />
    <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@watergis/maplibre-gl-terradraw@1.3.14/dist/maplibre-gl-terradraw.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@watergis/maplibre-gl-terradraw@1.3.14/dist/maplibre-gl-terradraw.umd.js"></script>
    <style>
      body,
      html,
      #map {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #layerButtons {
        display: none;
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        background: white;
        padding: 10px;
        border-radius: 4px;
        font-family: sans-serif;
      }
      #layerButtons button {
        display: block;
        margin: 5px 0;
        width: 180px;
        cursor: pointer;
      }
      /* New select styling */
      #areaSelectContainer {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        background: white;
        padding: 10px;
        border-radius: 4px;
        font-family: sans-serif;
        width: 150px;
      }
      #areaSelectContainer2 {
        position: absolute;
        top: 80px;
        right: 10px;
        z-index: 10;
        background: white;
        padding: 10px;
        border-radius: 4px;
        font-family: sans-serif;
        width: 150px;
      }
      #areaSelect {
        width: 100%;
        padding: 5px;
        font-size: 14px;
        cursor: pointer;
      }
      #areaSelect2 {
        width: 100%;
        padding: 5px;
        font-size: 14px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="layerButtons"></div>
    <!-- Select dropdown on the right side -->
    <div id="areaSelectContainer">
      <label for="areaSelect">Select Area (gaj):</label>
      <select id="areaSelect">
        <option value="all">All</option>
        <option value="50">50 gaj</option>
        <option value="100">100 gaj</option>
        <option value="200">200 gaj</option>
      </select>
    </div>
    <div id="areaSelectContainer2">
      <label for="areaSelect">Select Availability:</label>
      <select id="areaSelect2">
        <option value="all">All</option>
        <option value="available">Available</option>
        <option value="notAvailable">Not Available</option>
      </select>
    </div>
    <!-- Add this inside your <head> to include Turf.js for area calculation -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <script>
      // Master layers data (only one example here)
      const masterLayers = [
        {
          id: "master-layer-govind",
          sourceId: "master-layer-govind-source",
          bounds: [
            [77.62907088757926, 27.566921667936064],
            [77.63041173884528, 27.565373155858424],
            [77.62578876439667, 27.562141116684252],
            [77.62444473765403, 27.563580591534546],
          ],
          center: [77.62728318892533, 27.564615646925205],
          zoom: 18,
          path: "masterPlans/govindsharnamtotal.webp", // Make sure path is accessible
          isLayerLoaded: false,
          isLayerOn: false,
        },
      ];

      // Sample geojson data for Terra Draw with 'area' property for each polygon
      const geojsonData = {
        type: "FeatureCollection",
        features: [
          {
            id: "f71af018-42ad-4aa6-8448-6611ca428898",
            type: "Feature",
            geometry: {
              type: "Polygon",
              coordinates: [
                [
                  [77.626818972, 27.563646432],
                  [77.626726877, 27.563554636],
                  [77.626802527, 27.56349953],
                  [77.626839224, 27.563538611],
                  [77.626881746, 27.563583616],
                  [77.626892176, 27.563595562],
                  [77.626848253, 27.563626017],
                  [77.626818972, 27.563646432],
                ],
              ],
            },
            properties: {
              mode: "polygon",
              area: 100, // random choice
              avilable: true,
            },
          },
          {
            id: "dd2066b7-9ffb-4b02-9f26-2148e5b8e138",
            type: "Feature",
            geometry: {
              type: "Polygon",
              coordinates: [
                [
                  [77.626929739, 27.56356769],
                  [77.626913571, 27.56357923],
                  [77.626893583, 27.563594635],
                  [77.626857979, 27.563556936],
                  [77.626803515, 27.563498805],
                  [77.626839352, 27.563472408],
                  [77.626880927, 27.563442371],
                  [77.626970589, 27.563538575],
                  [77.626929739, 27.56356769],
                ],
              ],
            },
            properties: {
              mode: "polygon",
              area: 50, // random choice
              avilable: false,
            },
          },
          {
            id: "69cdb48f-2787-40b3-bd46-b74415087661",
            type: "Feature",
            geometry: {
              type: "Polygon",
              coordinates: [
                [
                  [77.62717073, 27.564179681],
                  [77.627144642, 27.564151677],
                  [77.627110773, 27.564115539],
                  [77.627166123, 27.564076081],
                  [77.627231065, 27.564028582],
                  [77.627247736, 27.564046625],
                  [77.627292727, 27.564091948],
                  [77.627236902, 27.564133017],
                  [77.62717073, 27.564179681],
                ],
              ],
            },
            properties: {
              mode: "polygon",
              area: 200, // random choice
              avilable: true,
            },
          },
          {
            id: "b4917060-fa26-4e0e-ab94-63b73b9ac0ba",
            type: "Feature",
            geometry: {
              type: "Polygon",
              coordinates: [
                [
                  [77.627294501, 27.564089965],
                  [77.627268627, 27.56406404],
                  [77.627233691, 27.564027532],
                  [77.627277403, 27.563995743],
                  [77.627333937, 27.563953754],
                  [77.627354565, 27.563939401],
                  [77.627385918, 27.563971636],
                  [77.627405177, 27.563991667],
                  [77.627415667, 27.564002879],
                  [77.627371192, 27.564034242],
                  [77.627331307, 27.564063318],
                  [77.627294501, 27.564089965],
                ],
              ],
            },
            properties: {
              mode: "polygon",
              area: 50, // random choice
              avilable: true,
            },
          },
          {
            id: "a4a91f6c-5839-4627-aecf-e9a29dad403c",
            type: "Feature",
            geometry: {
              type: "Polygon",
              coordinates: [
                [
                  [77.627109018, 27.564112984],
                  [77.627098495, 27.564103268],
                  [77.627082853, 27.564088707],
                  [77.627058897, 27.564062872],
                  [77.627067579, 27.56405675],
                  [77.627112415, 27.56402399],
                  [77.627179196, 27.563974612],
                  [77.627190659, 27.563985951],
                  [77.62721493, 27.564011563],
                  [77.627229124, 27.564026231],
                  [77.627171028, 27.564068342],
                  [77.627109018, 27.564112984],
                ],
              ],
            },
            properties: {
              mode: "polygon",
              area: 200, // random choice
              avilable: false,
            },
          },
          {
            id: "112825b4-052e-4417-b7c9-8e2fc538e3b1",
            type: "Feature",
            geometry: {
              type: "Polygon",
              coordinates: [
                [
                  [77.627129113, 27.563917402],
                  [77.627086871, 27.563873782],
                  [77.627080978, 27.563867215],
                  [77.62711358, 27.563842026],
                  [77.627159244, 27.563809274],
                  [77.627192182, 27.563785497],
                  [77.627201188, 27.563778597],
                  [77.627224387, 27.563802377],
                  [77.627244975, 27.563824975],
                  [77.627250291, 27.563830554],
                  [77.627184138, 27.563879294],
                  [77.627154461, 27.563900411],
                  [77.627129113, 27.563917402],
                ],
              ],
            },
            properties: {
              mode: "polygon",
              area: 100, // random choice
              avilable: true,
            },
          },
          {
            id: "8d3b393f-7d74-4642-b091-a7927e54fa9f",
            type: "Feature",
            geometry: {
              type: "Polygon",
              coordinates: [
                [
                  [77.627182501, 27.563585761],
                  [77.62715529, 27.563558347],
                  [77.627132378, 27.563534269],
                  [77.627182818, 27.563496962],
                  [77.627233495, 27.563460646],
                  [77.627266974, 27.563436458],
                  [77.627297008, 27.563467382],
                  [77.627318412, 27.563489051],
                  [77.627259981, 27.563529098],
                  [77.627222139, 27.56355752],
                  [77.627182501, 27.563585761],
                ],
              ],
            },
            properties: {
              mode: "polygon",
              area: 50, // random choice
              avilable: false,
            },
          },
          {
            id: "743e7c0e-9a8d-49e6-895b-d932dbd6661f",
            type: "Feature",
            geometry: {
              type: "Polygon",
              coordinates: [
                [
                  [77.627285731, 27.563693658],
                  [77.627236166, 27.563642061],
                  [77.627293147, 27.563598703],
                  [77.627352736, 27.563556492],
                  [77.627370445, 27.563543896],
                  [77.627398052, 27.563572479],
                  [77.627419403, 27.563594742],
                  [77.627285731, 27.563693658],
                ],
              ],
            },
            properties: {
              mode: "polygon",
              selected: false,
              area: 200, // random choice
              avilable: true,
            },
          },
          {
            id: "3d54e3ca-6669-47f5-8d9b-9d08f7d79f58",
            type: "Feature",
            geometry: {
              type: "Polygon",
              coordinates: [
                [
                  [77.626975881, 27.563758503],
                  [77.626911345, 27.563690305],
                  [77.626989088, 27.563632937],
                  [77.627031187, 27.563601093],
                  [77.627074599, 27.563646634],
                  [77.627096748, 27.563670679],
                  [77.627024594, 27.563723408],
                  [77.626975881, 27.563758503],
                ],
              ],
            },
            properties: {
              mode: "polygon",
              area: 50, // random choice
              avilable: true,
            },
          },
          {
            id: "bb528afb-964b-45fc-927d-e65aadb3db0c",
            type: "Feature",
            geometry: {
              type: "Polygon",
              coordinates: [
                [
                  [77.62627043, 27.563876468],
                  [77.626081523, 27.563686666],
                  [77.626421119, 27.563439837],
                  [77.626758078, 27.563195823],
                  [77.626852099, 27.563128261],
                  [77.626893824, 27.563162449],
                  [77.626954066, 27.563228847],
                  [77.627033778, 27.56331311],
                  [77.626625144, 27.563618964],
                  [77.62627043, 27.563876468],
                ],
              ],
            },
            properties: {
              mode: "polygon",
              area: 200, // random choice
              avilable: true,
            },
          },
          {
            id: "0a37cb97-8a47-4dc3-86cf-6c476ad6399c",
            type: "Feature",
            geometry: {
              type: "Polygon",
              coordinates: [
                [
                  [77.625709803, 27.563293775],
                  [77.625467303, 27.563040558],
                  [77.625926655, 27.562699488],
                  [77.626122294, 27.562563672],
                  [77.626208568, 27.562628785],
                  [77.626383448, 27.562790018],
                  [77.626020863, 27.563067008],
                  [77.625709803, 27.563293775],
                ],
              ],
            },
            properties: {
              mode: "polygon",
              area: 200, // random choice
              avilable: false,
            },
          },
        ],
      };

      // Initialize Maplibre GL map with a base raster layer (Google Satellite)
      const map = new maplibregl.Map({
        container: "map",
        style: {
          version: 8,
          sources: {
            "raster-tiles": {
              type: "raster",
              tiles: ["https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}"],
              tileSize: 256,
            },
          },
          layers: [
            {
              id: "simple-tiles",
              type: "raster",
              source: "raster-tiles",
              minzoom: 2,
              maxzoom: 22,
            },
          ],
        },
        center: [77.62362905089208, 27.57973612066543],
        zoom: 13,
        pitch: 0,
        bearing: 0,
      });

      // Add image sources and raster layers first (below TerraDraw)
      map.once("load", () => {
        masterLayers.forEach((layer) => {
          map.addSource(layer.sourceId, {
            type: "image",
            url: layer.path,
            coordinates: layer.bounds,
          });
          map.addLayer({
            id: layer.id,
            type: "raster",
            source: layer.sourceId,
            paint: { "raster-opacity": 1 },
          });
          layer.isLayerLoaded = true;
          layer.isLayerOn = true;
        });

        fitBoundToLayer(masterLayers[0].center, masterLayers[0].zoom);

        // Add the polygons source and layer for coloring
        addPolygonsLayer(geojsonData.features);

        // Setup listener on select dropdown
        document
          .getElementById("areaSelect")
          .addEventListener("change", (e) => {
            const selectedArea = e.target.value;
            filterPolygonsByArea(selectedArea);
          });
        document
          .getElementById("areaSelect2")
          .addEventListener("change", (e) => {
            const avilable = e.target.value;
            filterAvailable(avilable);
          });
      });

      function fitBoundToLayer(center, zoom) {
        map.flyTo({
          center: center,
          zoom: zoom,
          duration: 3000,
          pitch: 0,
          bearing: 0,
        });
      }

      function addPolygonsLayer(features) {
        // Remove existing source/layer if any (to allow refresh)
        if (map.getLayer("polygons-layer")) {
          map.removeLayer("polygons-layer");
        }
        if (map.getSource("polygons-source")) {
          map.removeSource("polygons-source");
        }

        // Add source with all features initially
        map.addSource("polygons-source", {
          type: "geojson",
          data: {
            type: "FeatureCollection",
            features: features,
          },
        });

        // Add a fill layer with paint color based on 'area' property
        map.addLayer({
          id: "polygons-layer",
          type: "fill",
          source: "polygons-source",
          paint: {
            "fill-color": [
              "case",
              ["==", ["get", "area"], 50],
              "rgba(0, 128, 0, 0.5)", // green with 0.5 opacity
              ["==", ["get", "area"], 100],
              "rgba(255, 0, 0, 0.5)", // red with 0.5 opacity
              ["==", ["get", "area"], 200],
              "rgba(0, 0, 255, 0.5)", // blue with 0.5 opacity
              "rgba(0,0,0,0)", // default transparent if no match
            ],
            "fill-outline-color": "#000000",
          },
        });
        map.addLayer({
          id: "polygons-outline-layer",
          type: "line",
          source: "polygons-source",
          paint: {
            "line-color": [
              "case",
              ["==", ["get", "area"], 50],
              "rgba(0, 0, 0, 0.5)", // black with 0.5 opacity
              ["==", ["get", "area"], 100],
              "rgba(0, 0, 0, 0.5)",
              ["==", ["get", "area"], 200],
              "rgba(0, 0, 0, 0.5)",
              "rgba(0, 0, 0, 0)", // transparent for others
            ],
            "line-width": 5, // Adjust thickness as needed
          },
        });
      }

      // Filter polygons by area and update layer's filter
      //   function filterPolygonsByArea(selectedArea) {
      //     if (selectedArea === "all") {
      //       // Show all polygons
      //       map.setFilter("polygons-layer", null);
      //     } else {
      //       // Filter to show only polygons with selected area
      //       const areaValue = Number(selectedArea);
      //       map.setFilter("polygons-layer", ["==", ["get", "area"], areaValue]);
      //     }
      //   }
      function filterPolygonsByArea(selectedArea) {
        if (selectedArea === "all") {
          // Show all polygons with opacity 0.5
          map.setPaintProperty("polygons-layer", "fill-color", [
            "case",
            ["==", ["get", "area"], 50],
            "rgba(0, 128, 0, 0.5)",
            ["==", ["get", "area"], 100],
            "rgba(255, 0, 0, 0.5)",
            ["==", ["get", "area"], 200],
            "rgba(0, 0, 255, 0.5)",
            "rgba(0,0,0,0)",
          ]);
          map.setPaintProperty(
            "polygons-layer",
            "fill-outline-color",
            "#000000"
          );

          // Show all outlines (black, 0.5 opacity, 3px width)
          map.setPaintProperty("polygons-outline-layer", "line-color", [
            "case",
            ["==", ["get", "area"], 50],
            "rgba(0, 0, 0, 0.5)",
            ["==", ["get", "area"], 100],
            "rgba(0, 0, 0, 0.5)",
            ["==", ["get", "area"], 200],
            "rgba(0, 0, 0, 0.5)",
            "rgba(0,0,0,0)",
          ]);
          map.setPaintProperty("polygons-outline-layer", "line-width", 3);
        } else {
          const areaValue = Number(selectedArea);

          // Fill color with 0.5 opacity for matching, transparent for others
          map.setPaintProperty("polygons-layer", "fill-color", [
            "case",
            ["==", ["get", "area"], areaValue],
            areaValue === 50
              ? "rgba(0, 128, 0, 0.5)"
              : areaValue === 100
              ? "rgba(255, 0, 0, 0.5)"
              : "rgba(0, 0, 255, 0.5)",
            "rgba(0,0,0,0)",
          ]);

          // Outline color: visible for matching, transparent for others
          map.setPaintProperty("polygons-layer", "fill-outline-color", [
            "case",
            ["==", ["get", "area"], areaValue],
            "rgba(0,0,0,0.5)",
            "rgba(0,0,0,0)",
          ]);

          // Line color and width: visible for matching, hidden for others
          map.setPaintProperty("polygons-outline-layer", "line-color", [
            "case",
            ["==", ["get", "area"], areaValue],
            "rgba(0, 0, 0, 0.5)",
            "rgba(0, 0, 0, 0)",
          ]);
          map.setPaintProperty("polygons-outline-layer", "line-width", [
            "case",
            ["==", ["get", "area"], areaValue],
            3,
            0,
          ]);
        }
      }

      const filterAvailable = (availableStatus) => {
        console.log("availableStatus:", availableStatus);

        if (availableStatus === "all") {
          // Show all polygons, no filter on either layer
          map.setFilter("polygons-layer", null);
          map.setFilter("polygons-outline-layer", null);

          // Restore original area-based styling
          map.setPaintProperty("polygons-layer", "fill-color", [
            "case",
            ["==", ["get", "area"], 50],
            "rgba(0, 128, 0, 0.5)", // green
            ["==", ["get", "area"], 100],
            "rgba(255, 0, 0, 0.5)", // red
            ["==", ["get", "area"], 200],
            "rgba(0, 0, 255, 0.5)", // blue
            "rgba(0, 0, 0, 0)",
          ]);

          map.setPaintProperty(
            "polygons-layer",
            "fill-outline-color",
            "#000000"
          );

          map.setPaintProperty("polygons-outline-layer", "line-color", [
            "case",
            ["==", ["get", "area"], 50],
            "rgba(0, 0, 0, 0.5)",
            ["==", ["get", "area"], 100],
            "rgba(0, 0, 0, 0.5)",
            ["==", ["get", "area"], 200],
            "rgba(0, 0, 0, 0.5)",
            "rgba(0, 0, 0, 0)",
          ]);

          map.setPaintProperty("polygons-outline-layer", "line-width", 3);
        } else if (availableStatus === "available") {
          // Filter polygons and outlines to show only available polygons
          map.setFilter("polygons-layer", ["==", ["get", "avilable"], true]);
          map.setFilter("polygons-outline-layer", [
            "==",
            ["get", "avilable"],
            true,
          ]);

          // Color fill green
          map.setPaintProperty(
            "polygons-layer",
            "fill-color",
            "rgba(0, 128, 0, 0.6)"
          );
          // Outline black semi-transparent
          map.setPaintProperty(
            "polygons-layer",
            "fill-outline-color",
            "rgba(0,0,0,0.5)"
          );
          map.setPaintProperty(
            "polygons-outline-layer",
            "line-color",
            "rgba(0,0,0,0.5)"
          );
          map.setPaintProperty("polygons-outline-layer", "line-width", 3);
        } else if (availableStatus === "notAvailable") {
          // Filter polygons and outlines to show only unavailable polygons
          map.setFilter("polygons-layer", ["==", ["get", "avilable"], false]);
          map.setFilter("polygons-outline-layer", [
            "==",
            ["get", "avilable"],
            false,
          ]);

          // Color fill red
          map.setPaintProperty(
            "polygons-layer",
            "fill-color",
            "rgba(255, 0, 0, 0.6)"
          );
          // Outline black semi-transparent
          map.setPaintProperty(
            "polygons-layer",
            "fill-outline-color",
            "rgba(0,0,0,0.5)"
          );
          map.setPaintProperty(
            "polygons-outline-layer",
            "line-color",
            "rgba(0,0,0,0.5)"
          );
          map.setPaintProperty("polygons-outline-layer", "line-width", 3);
        }
      };

      map.on("click", "polygons-layer", function (e) {
        const feature = e.features[0];
        const { avilable, area } = feature.properties;
        const coordinates = e.lngLat;

        // Create popup content
        const popupContent = `
    <strong>Available:</strong> ${avilable}<br>
    <strong>Area:</strong> ${area}
  `;

        // Create and display the popup
        new maplibregl.Popup()
          .setLngLat(coordinates)
          .setHTML(popupContent)
          .addTo(map);
      });

      // // Terra Draw Control setup remains the same
      // const drawControl = new MaplibreTerradrawControl.MaplibreTerradrawControl(
      //   {
      //     modes: [
      //       "render",
      //       "point",
      //       "linestring",
      //       "polygon",
      //       "rectangle",
      //       "circle",
      //       "freehand",
      //       "angled-rectangle",
      //       "sensor",
      //       "sector",
      //       "select",
      //       "delete-selection",
      //       "delete",
      //       "download",
      //     ],
      //     open: true,
      //     computeElevation: true,
      //   }
      // );
      // map.addControl(drawControl, "top-left");
      // const drawInstance = drawControl.getTerraDrawInstance();
      // map.once("load", () => {
      //   if (drawInstance) {
      //     // Add all polygons regardless of area initially
      //     //   drawInstance.addFeatures(geojsonData.features);
      //     console.log(drawInstance);
      //     console.log("Current mode:", drawInstance.mode);

      //     console.log(
      //       "All supported event types:",
      //       Object.keys(drawInstance._eventListeners)
      //     );

      //     // Add listener for feature creation

      //     drawInstance.on("finish", (event) => {
      //       console.log(event);
      //       const feature = drawInstance._store.store[event]; // access the store object by ID key

      //       console.log("Finished feature GeoJSON:", feature);
      //     });
      //   }
      // });
      // Listen for when a new geometry is created
    </script>
  </body>
</html>
